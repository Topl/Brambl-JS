<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>modules/KeyManager.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Brambl.html">Brambl</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Brambl.html#.Hash">Hash</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Brambl.html#.KeyManager">KeyManager</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Brambl.html#.Requests">Requests</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Brambl.html#addSigToTx">addSigToTx</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Brambl.html#createAssetCode">createAssetCode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Brambl.html#pollTx">pollTx</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Brambl.html#signAndBroadcast">signAndBroadcast</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Brambl.html#transaction">transaction</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Hash.html">Hash</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Hash.html#.any">any</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Hash.html#.file">file</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Hash.html#.string">string</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="KeyManager.html">KeyManager</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="KeyManager.html#.GetKeyStorage">GetKeyStorage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="KeyManager.html#.Verify">Verify</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="KeyManager.html#exportToFile">exportToFile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="KeyManager.html#lockKey">lockKey</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="KeyManager.html#sign">sign</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="KeyManager.html#unlockKey">unlockKey</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="KeyManager.KeyManager.html">KeyManager</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Requests.html">Requests</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#broadcastTx">broadcastTx</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#createRawArbitTransfer">createRawArbitTransfer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#createRawAssetTransfer">createRawAssetTransfer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#createRawPolyTransfer">createRawPolyTransfer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#getBlockByHeight">getBlockByHeight</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#getBlockById">getBlockById</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#getLatestBlock">getLatestBlock</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#getMempool">getMempool</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#getTransactionById">getTransactionById</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#getTransactionFromMempool">getTransactionFromMempool</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#lookupBalancesByAddresses">lookupBalancesByAddresses</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#setApiKey">setApiKey</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#setUrl">setUrl</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="utils_address-utils.module_js.html">utils/address-utils.js</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_address-utils.module_js.html#~createAssetCode">createAssetCode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_address-utils.module_js.html#~extractAddressesFromObj">extractAddressesFromObj</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_address-utils.module_js.html#~generatePubKeyHashAddress">generatePubKeyHashAddress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_address-utils.module_js.html#~getAddressNetwork">getAddressNetwork</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_address-utils.module_js.html#~getDecimalByNetwork">getDecimalByNetwork</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_address-utils.module_js.html#~getHexByNetwork">getHexByNetwork</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_address-utils.module_js.html#~getValidNetworksList">getValidNetworksList</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_address-utils.module_js.html#~isValidAssetCode">isValidAssetCode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_address-utils.module_js.html#~isValidMetadata">isValidMetadata</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_address-utils.module_js.html#~isValidNetwork">isValidNetwork</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_address-utils.module_js.html#~validateAddressesByNetwork">validateAddressesByNetwork</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html">utils/key-utils.js</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~decrypt">decrypt</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~deriveKey">deriveKey</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~dump">dump</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~encrypt">encrypt</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~generateKeystoreFilename">generateKeystoreFilename</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~getMAC">getMAC</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~isCipherAvailable">isCipherAvailable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~keysEncodedFormat">keysEncodedFormat</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~marshal">marshal</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~recover">recover</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~str2buf">str2buf</a></span></li><li class="nav-heading">Namespaces</li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#bramblRequest">bramblRequest</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#digestAndEncode">digestAndEncode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#hashFunc">hashFunc</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">modules/KeyManager.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Create, import, and export Topl Bifrost keys.
 * Also allows for signing of transactions.
 *
 * @author James Aman (j.aman@topl.me)
 * @author Raul Aragonez (r.aragonez@topl.me)
 *
 * @namespace KeyManager
 */

// Initial implementation of this lib isBased on the keythereum library from Jack Peterson https://github.com/Ethereumjs/keythereum
"use strict";

// Dependencies
const fs = require("fs");
const path = require("path");
const crypto = require("crypto");
const curve25519 = require("curve25519-js");
const {create, dump, recover, str2buf, generateKeystoreFilename} = require("../utils/key-utils.js");

// utils
const utils = require("../utils/address-utils.js");

// Default options for key generation as of 2021.02.04
const defaultOptions = {
  // Symmetric cipher for private key encryption
  cipher: "aes-256-ctr",

  // Initialization vector size in bytes
  ivBytes: 16,

  // Private key size in bytes
  keyBytes: 32,

  // Key derivation function parameters
  scrypt: {
    dkLen: 32,
    n: Math.pow(2, 18), // cost (as given in bifrost)
    r: 8, // blocksize
    p: 1 // parallelization
  },

  // networkPrefix
  networkPrefix: "private"
};

/* -------------------------------------------------------------------------- */
/*                           Key Manager Class                                */
/* -------------------------------------------------------------------------- */
/**
 * @class KeyManager
 * @memberof KeyManager
 * @classdesc Create a new instance of the Key management interface.
 */
class KeyManager {
    // Private variables
    #sk;
    #isLocked;
    #password;
    #keyStorage;
    #pk;
    #networkPrefix;
    #address;

    /* ------------------------------ Instance constructor ------------------------------ */
    /**
     * @constructor
     * @param {object} params constructor object for key manager or as a string password
     * @param {string} [params.password] password for encrypting (decrypting) the keyfile
     * @param {string} [params.keyPath] path to import keyfile
     * @param {object} [params.constants] default encryption options for storing keyfiles
     * @param {string} [params.networkPrefix] Network Prefix, defaults to "private"
     */
    constructor(params) {
      // enforce that a password must be provided
      if (!params || (params.constructor !== String &amp;&amp; !params.password)) throw new Error("A password must be provided at initialization");

      /**
       * Initializes a key manager object with a key storage object
       *
       * @param {object} keyStorage - The keyStorage object that the keyManager will use to store the keys for a particular address.
       * @param {string} password for encrypting (decrypting) the keyfile
       * @returns {object} Returns the key storage used in the keyManager
       */

      const initKeyStorage = (keyStorage, password) => {
        this.#address = keyStorage.address;
        this.#isLocked = false;
        this.#password = password;
        this.#keyStorage = keyStorage;

        if (this.#address) {
          [this.#sk, this.#pk] = recover(password, keyStorage, this.constants.scrypt);
        }
      };

      /**
       * Generates a new curve25519 key pair and dumps them to an encrypted format
       * @param {string} password password for encrypting (decrypting) the keyfile
       * @returns {object}
       */

      const generateKey = (password) => {
        // this will create a new curve25519 key pair and dump to an encrypted format
        initKeyStorage(dump(password, create(this.constants), this.constants), password);
      };

      /**
       * Imports key data object from keystore JSON file.
       * @param {string} filepath the filepath of the keystore JSON
       * @param {string} password the password for encrypting/decrypting * the keyfile
       * @returns {object} returns the keyStorage used in the KeyManager
       */
      const importFromFile = (filepath, password) => {
        const keyStorage = JSON.parse(fs.readFileSync(filepath));

        // check if address is valid and has a valid network
        if (keyStorage.address) {
          // determine prefix and set networkPrefix
          const prefixResult = utils.getAddressNetwork(keyStorage.address);
          if (prefixResult.success) {
            this.#networkPrefix = prefixResult.networkPrefix;
          } else {
            throw new Error(prefixResult.error);
          }

          // validate address
          const validationResult = utils.validateAddressesByNetwork(this.networkPrefix, keyStorage.address);
          if (!validationResult.success) {
            throw new Error("Invalid Addresses::" +
              " Network Type: &lt;" + this.networkPrefix + ">" +
              " Invalid Addresses: &lt;" + validationResult.invalidAddresses + ">" +
              " Invalid Checksums: &lt;" + validationResult.invalidChecksums + ">");
          }

          initKeyStorage(keyStorage, password);
        } else {
          throw new Error("No address found in key");
        }
      };

      // initialize variables
      this.constants = params.constants || defaultOptions;

      // set networkPrefix and validate
      this.#networkPrefix = params.networkPrefix || "private";

      // ensure constant include this.#networkPrefix for key creation
      this.constants.networkPrefix = this.#networkPrefix;

      if (this.#networkPrefix !== "private" &amp;&amp; !utils.isValidNetwork(this.#networkPrefix)) {
        throw new Error(`Invalid Network Prefix. Must be one of: ${utils.getValidNetworksList()}`);
      }

      initKeyStorage({address: "", crypto: {}}, "");

      // load in keyfile if a path was given, or default to generating a new key
      if (params.keyPath) {
        try {
          importFromFile(params.keyPath, params.password);
        } catch (err) {
          throw new Error("Error importing keyfile - " + err);
        }
      } else {
        // Will check if only a string was given and assume it is the password
        if (params.constructor === String) generateKey(params);
        else generateKey(params.password);
      }
    }

    /* ------------------------------ Static methods ------------------------------------ */
    /**
     * Check whether a private key was used to generate the signature for a message.
     * This method is static so that it may be used without generating a keyfile
     * @function Verify
     * @memberof KeyManager
     * @static
     * @param {Buffer|string} publicKey A public key (if string, must be base-58 encoded)
     * @param {string} message Message to sign (utf-8 encoded)
     * @param {Buffer|string} signature Signature to verify (if string, must be base-58 encoded)
     * @returns {function} returns function Verify
     * @memberof KeyManager
     */
    static verify(publicKey, message, signature) {
      const pk = str2buf(publicKey);
      const msg = str2buf(message, "base58");
      const sig = str2buf(signature);

      return curve25519.verify(pk, msg, sig);
    };

    /* ------------------------------ Public methods -------------------------------- */
    /**
     * Getter function to retrieve key storage in the Bifrost compatible format
     * @function GetKeyStorage
     * @memberof KeyManager
     * @returns {object} returns value of private var keyStorage
     */
    getKeyStorage() {
      if (this.#isLocked) throw new Error("Key manager is currently locked. Please unlock and try again.");
      if (!this.#pk) throw new Error("A key must be initialized before using this key manager");
      return this.#keyStorage;
    }

    /**
     * Set the key manager to locked so that the private key may not be decrypted
     * @memberof KeyManager
     * @returns {void}
     */
    lockKey() {
      this.#isLocked = true;
    }

    /**
     * Getter for private property #isLocked
     * @memberof KeyManager
     * @returns {boolean} value of #isLocked
     */
    get isLocked() {
      return this.#isLocked;
    }

    /**
     * Setter for private property #isLocked
     * @memberof KeyManager
     * @param {any} args ignored, only necessary for setter
     * @returns {void} Error is thrown to protect private variable
     */
    set isLocked(args) {
      throw new Error("Invalid private variable access, use lockKey() instead.");
    }

    /**
     * Getter for private property #pk
     * @memberof KeyManager
     * @returns {string} value of #pk (public key string)
     */
    get pk() {
      return this.#pk;
    }

    /**
     * Setter for private property #pk
     * @memberof KeyManager
     * @param {any} args ignored, only necessary for setter
     * @returns {void} Error is thrown to protect private variable
     */
    set pk(args) {
      throw new Error("Invalid private variable access, instantiate a new KeyManager instead.");
    }

    /**
     * Getter for private property #address
     * @memberof KeyManager
     * @param {any} args ignored, only necessary for setter
     * @returns {void} Error is thrown to protect private variable
     */
    get address() {
      return this.#address;
    }

    /**
     * Setter for private property #address
     * @memberof KeyManager
     * @param {any} args ignored, only necessary for setter
     * @returns {void} Error is thrown to protect private variable
     */
    set address(args) {
      throw new Error("Invalid private variable access, instantiate a new KeyManager instead.");
    }

    /**
     * Getter for private property #networkPrefix
     * @memberof KeyManager
     * @returns {string} value of #networkPrefix
     */
    get networkPrefix() {
      return this.#networkPrefix;
    }

    /**
     * Setter for private property #isLocked
     * @memberof KeyManager
     * @param {any} args ignored, only necessary for setter
     * @returns {void} Error is thrown to protect private variable
     */
    set networkPrefix(args) {
      throw new Error("Invalid private variable access.");
    }

    /**
     * Unlock the key manager to be used in transactions
     * @param {string} password encryption password for accessing the keystorage object
     * @memberof KeyManager
     * @returns {void}
     */
    unlockKey(password) {
      if (!this.#isLocked) throw new Error("The key is already unlocked");
      if (password !== this.#password) throw new Error("Invalid password");
      this.#isLocked = false;
    }

    /**
     * Generate the signature of a message using the provided private key
     * @param {string} message Message to sign (utf-8 encoded)
     * @memberof KeyManager
     * @returns {Uint8Array} signature
     */
    sign(message) {
      if (this.#isLocked) throw new Error("The key is currently locked. Please unlock and try again.");
      if (!this.#sk) throw new Error("A key must be initialized before using this key manager");
      if (!message || message.constructor !== String) throw new Error("Invalid message provided as argument.");

      return curve25519.sign(str2buf(this.#sk), str2buf(message, "base58"), crypto.randomBytes(64));
    }

    /**
     * Export formatted JSON to keystore file.
     * @param {string=} _keyPath Path to keystore folder (default: ".keyfiles")
     * @returns {string} JSON filename
     * @memberof KeyManager
     */
    exportToFile(_keyPath) {
      if (this.#isLocked) throw new Error("The key is currently locked. Please unlock and try again.");
      if (!this.#pk) throw new Error("A key must be initialized before using this key manager");
      if (_keyPath &amp;&amp; _keyPath.constructor !== String) throw new Error("Invalid keypath provided as argument.");

      const keyPath = _keyPath || ".keyfiles";
      const outfile = generateKeystoreFilename(this.#pk);
      const json = JSON.stringify(this.getKeyStorage());
      const outpath = path.join(keyPath, outfile);

      // write file and return outpath if successful or throw error
      try {
        // create default directory if it doesn't exist
        if (keyPath === ".keyfiles" &amp;&amp; !fs.existsSync(keyPath)) {
          fs.mkdirSync(keyPath);
        }
        // write file
        fs.writeFileSync(outpath, json);
      } catch (error) {
        throw new Error("Error exporting to file." + error);
      }

      return outpath;
    }
};

/* -------------------------------------------------------------------------- */

module.exports = KeyManager;

/* -------------------------------------------------------------------------- */
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Tue May 11 2021 15:58:35 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
