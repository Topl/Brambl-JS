<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>utils/address-utils.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Brambl.html">Brambl</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Brambl.html#.Hash">Hash</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Brambl.html#.KeyManager">KeyManager</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Brambl.html#.Requests">Requests</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Brambl.html#addSigToTx">addSigToTx</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Brambl.html#pollTx">pollTx</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Brambl.html#signAndBroadcast">signAndBroadcast</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Brambl.html#transaction">transaction</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Hash.html">Hash</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Hash.html#.any">any</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Hash.html#.file">file</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Hash.html#.string">string</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="KeyManager%250A%250ABased%2520on%2520the%2520keythereum%2520library%2520from%2520Jack%2520Peterson%250Ahttps___github.com_Ethereumjs_keythereummodule_-KeyManager.html">KeyManager</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Requests.html">Requests</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#broadcastTx">broadcastTx</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#createRawArbitTransfer">createRawArbitTransfer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#createRawAssetTransfer">createRawAssetTransfer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#createRawPolyTransfer">createRawPolyTransfer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#getBlockByHeight">getBlockByHeight</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#getBlockById">getBlockById</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#getLatestBlock">getLatestBlock</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#getMempool">getMempool</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#getTransactionById">getTransactionById</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#getTransactionFromMempool">getTransactionFromMempool</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#lookupBalancesByKey">lookupBalancesByKey</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#setApiKey">setApiKey</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Requests.html#setUrl">setUrl</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="KeyManager%250A%250ABased%2520on%2520the%2520keythereum%2520library%2520from%2520Jack%2520Peterson%250Ahttps___github.com_Ethereumjs_keythereummodule_.html">KeyManager

Based on the keythereum library from Jack Peterson
https://github.com/Ethereumjs/keythereum</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="utils_address-utils.module_js.html">utils/address-utils.js</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_address-utils.module_js.html#~validateAddressesByNetwork">validateAddressesByNetwork</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html">utils/key-utils.js</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~decrypt">decrypt</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~deriveKey">deriveKey</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~dump">dump</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~encrypt">encrypt</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~generateKeystoreFilename">generateKeystoreFilename</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~getMAC">getMAC</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~isCipherAvailable">isCipherAvailable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~keysEncodedFormat">keysEncodedFormat</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~marshal">marshal</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~recover">recover</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="utils_key-utils.module_js.html#~str2buf">str2buf</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#bramblRequest">bramblRequest</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#digestAndEncode">digestAndEncode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#hashFunc">hashFunc</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">utils/address-utils.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileOverview Utility encryption related functions for KeyManager module.
 *
 * @author Raul Aragonez (r.aragonez@topl.me)
 *
 * @exports utils isValidNetwork, getUrlByNetwork, getHexByNetwork, getDecimalByNetwork, getValidNetworksList, validateAddressesByNetwork, generateAddress
 */

"use strict";

// Dependencies
const Base58 = require("base-58");
const blake = require("blake2");

const validNetworks = ['local', 'private', 'toplnet', 'valhalla', 'hel'];

const networksDefaults = {
  'local': {
    hex: "0x30",
    decimal: 48,
    url: "http://localhost:9085/"
  },
  'private': {
    hex: "0x40",
    decimal: 64,
    url: "http://localhost:9085/"
  },
  'toplnet': {
    hex: "0x01",
    decimal: 1,
    url: "https://torus.topl.services"
  },
  'valhalla': {
    hex: "0x10",
    decimal: 16,
    url: "https://valhalla.torus.topl.services"
  },
  'hel': {
    hex: "0x20",
    decimal: 32,
    url: "https://hel.torus.topl.services"
  }
};

function str2buf(str, enc) {
  if (!str || str.constructor !== String) return str;
  return enc ? Buffer.from(str, enc) : Buffer.from(Base58.decode(str));
}


// TODO: include errors if the addresses are not valid. Include queue.

/**
 * Check if addresses are valid by verifying these belong to the same network.
 * @param {String} networkPrefix
 * @param {Object} params
 * @param {Array} addresses
 */
/**
   * 1. verify the address is not null - DONE
   * 2. verify the base58 is 38 bytes long
   * 3. verify that it matches the network
   * 4. verify that hash matches the last 4 bytes?
   * 5. verify that address is multi-sig vs uni-sig? NO
   *
   * return an object
   * {
   *  success: true,
   *  errorMsg: "",
   *  networkPrefix: "local",
   *  addresses:
   *  [
  *     {
            "address": "86tS2ExvjGEpS3Ntq5vZgHirUMuee7pJELGD8GmBoUyjXpAaAXTz",
            "network": "local"
        },
        {
            "address": "77tS2ExvjGEpS3Ntq5vZgHirUMuee7pJELGD8GmBoUyjXpAaAXTz",
            "network": "valhalla"
        }
   *  ]
   * }
   */
function validateAddressesByNetwork(networkPrefix, addresses){
  // response upon the completion of validation
  let result = {
    success: false,
    errorMsg: "",
    networkPrefix: networkPrefix,
    addresses: [],
    invalidAddresses: []
  };

  // check if network is valid
  if(!isValidNetwork(networkPrefix)){
    result.errorMsg = "Invalid network provided";
    return result;
  }

  if(!addresses){
    result.errorMsg = "No addresses provided";
    return result;
  }

  // get decimal of the network prefix
  const networkDecimal = getDecimalByNetwork(networkPrefix);

  // addresses can be passed as an array or extracted from a json obj
  result.addresses = addresses.constructor === Array ? addresses : extractAddressesFromObj(addresses);

  // check if addresses were obtained
  if(!result.addresses || result.addresses.length &lt; 1){
    result.errorMsg = "No addresses found";
    return result;
  }

  // run validation on addresses, if address is not valid then add it to invalidAddresses array
  result.addresses.forEach(address => {
    const decodedAddress = Base58.decode(address);

    // validation: base58 38 byte obj that matches networkPrefix decimal
    if(decodedAddress.length !== 38 || decodedAddress[0] !== networkDecimal){
      result.invalidAddresses.push(address);
    } else {
      // address has correct length and matches the network, now validate the checksum
      const checksumBuffer = Buffer.from(decodedAddress.slice(34));

      // encrypt message (bytes 1-34)
      const msgBuffer = Buffer.from(decodedAddress.slice(0,34));
      const hashChecksumBuffer = blake.createHash("blake2b", {digestLength:32}).update(msgBuffer).end().read().slice(0, 4);

      // verify checksum bytes match
      if(!checksumBuffer.equals(hashChecksumBuffer)){
        result.invalidAddresses.push(address);
      }
    }
  });

  // check if any invalid addresses were found
  if(result.invalidAddresses.length > 0){
    result.errorMsg = "Invalid addresses for network: " + networkPrefix
  } else {
    result.success = true;
  }

  // TODO: Remove this console logs.
  console.log("Addresses validation result: ");
  console.log(result);

  return result;
}

function generateAddress(publicKey, networkPrefix) {
  let result = {
    success: false,
    errorMsg: "",
    networkPrefix: networkPrefix,
    address: "",
  };

  // validate Network Prefix
  if(!isValidNetwork(networkPrefix)){
    result.errorMsg = "Invalid network provided";
    return result;
  }

  // validate public key
  if(publicKey.length !== 32){
    result.errorMsg = "Invalid publicKey length";
    return result;
  }

  // include evidence with network prefix and multisig
  const networkHex = getHexByNetwork(networkPrefix);
  const netSigBytes = new Uint8Array([networkHex, '0x01']); // network decimal + multisig
  const evidence = blake.createHash("blake2b", {digestLength: 32}).update(publicKey).digest(); // hash it

  const concatEvidence = Buffer.concat([netSigBytes, evidence], 34); // insert the publicKey

  // get the hash of these 2, add first 4 bytes to the end.
  const hashChecksumBuffer = blake.createHash("blake2b", {digestLength:32}).update(concatEvidence).end().read().slice(0, 4);
  const address = Buffer.concat([concatEvidence, hashChecksumBuffer], 38);

  result.address = Base58.encode(address);
  result.success = true;
  return result;
}

function extractAddressesFromObj(obj){
  /**
   params =
    {
        "propositionType": "PublicKeyCurve25519",
        "changeAddress": "899tS2ExvjGEpS3Ntq5vZgHirUMuee7pJELGD8GmBoUyjXpAaAXTz",
        "consolidationAdddress": "899tS2ExvjGEpS3Ntq5vZgHirUMuee7pJELGD8GmBoUyjXpAaAXTz",
        "recipients": [["899tS2ExvjGEpS3Ntq5vZgHirUMuee7pJELGD8GmBoUyjXpAaAXTz", 10]],
        "sender": ["899tS2ExvjGEpS3Ntq5vZgHirUMuee7pJELGD8GmBoUyjXpAaAXTz"],
        "addresses": ["899tS2ExvjGEpS3Ntq5vZgHirUMuee7pJELGD8GmBoUyjXpAaAXTz"],
        "fee": 1,
        "data": ""
    };
   */

  // only push unique items in array, so that validation is faster
  let addresses = [];
  if (obj.constructor === String){
    return obj;
  }
  //obj = obj;
  // if(obj.constructor === Array){
  //   obj = obj[0];
  // }

  // make this parser a bit faster, use strings or array logic
  var addKeys = ["recipients", "sender", "changeAddress", "consolidationAdddress", "addresses"]

  // addKeys.forEach(addKey => {
  //   if(obj[addKey]){
  //     if(addKey === 'recipient'){

  //     } else {
  //       addresses.concat(obj[addKey]);
  //     }
  //   }
  // });

  if(obj['changeAddress']){
   addresses.push(obj["changeAddress"]);
  }
  if(obj["consolidationAdddress"]){
    addresses.push(obj["consolidationAdddress"]);
  }

  if(obj["recipients"] &amp;&amp; obj["recipients"].length > 0){
    obj["recipients"].forEach(address => {
      addresses.push(address[0]);
    });
  }
  if(obj["sender"] &amp;&amp; obj["sender"].length > 0){
    obj["sender"].forEach(address => {
      addresses.push(address);
    });
  }
  if(obj["addresses"] &amp;&amp; obj["addresses"].length > 0){
    obj["addresses"].forEach(address => {
      addresses.push(address);
    });
  }
  //console.log("addresses list: "+ addresses);
  return addresses;
}
/*** ------  TESTING FOR RAUL -------*/

let arrExample = [
  '86tS2ExvjGEpS3Ntq5vZgHirUMuee7pJELGD8GmBoUyjXpAaAXTz',
  '86tS2ExvjGEpS3Ntq5vZgHirUMuee7pJELGD8GmBoUyjXpAaAXTz',
  '86tS2ExvjGEpS3Ntq5vZgHirUMuee7pJELGD8GmBoUyjXpAaAXTz',
  '86tS2ExvjGEpS3Ntq5vZgHirUMuee7pJELGD8GmBoUyjXpAaAXTz',
  '86tS2ExvjGEpS3Ntq5vZgHirUMuee7pJELGD8GmBoUyjXpAaAXTz'
];
//let addValidationRes2 = validateAddressesByNetwork('local', arrExample);

// let arrSingle = ['AUAftQsaga8DjVfVvq7DK14fm5HvGEDdVLZwexZZvoP7oWkWCLoE'];
// let addValidationRes2 = validateAddressesByNetwork('private', arrSingle);
// console.log(addValidationRes2);


let paramObj =
  {
      "propositionType": "PublicKeyCurve25519",
      "changeAddress": "86tS2ExvjGEpS3Ntq5vZgHirUMuee7pJELGD8GmBoUyjXpAaAXTz",
      "consolidationAdddress": "86tS2ExvjGEpS3Ntq5vZgHirUMuee7pJELGD8GmBoUyjXpAaAXTz",
      "recipients": [["86tS2ExvjGEpS3Ntq5vZgHirUMuee7pJELGD8GmBoUyjXpAaAXTz", 10]],
      "sender": ["86tS2ExvjGEpS3Ntq5vZgHirUMuee7pJELGD8GmBoUyjXpAaAXTz"],
      "addresses": ["86tS2ExvjGEpS3Ntq5vZgHirUMuee7pJELGD8GmBoUyjXpAaAXTz"],
      "fee": 1,
      "data": ""
  }
;

//extractAddressesFromObj(paramObj);
//let addValidationRes = validateAddressesByNetwork('local', paramObj);
//console.log(addValidationRes);

function isValidNetwork(networkPrefix) {
  return networkPrefix &amp;&amp; validNetworks.includes(networkPrefix);
}

function getUrlByNetwork(networkPrefix) {
  return networksDefaults[networkPrefix].url;
}

function getHexByNetwork(networkPrefix) {
  return networksDefaults[networkPrefix].hex;
}

function getDecimalByNetwork(networkPrefix) {
  return networksDefaults[networkPrefix].decimal;
}
function getValidNetworksList() {
  return validNetworks;
}

module.exports = {isValidNetwork, getUrlByNetwork, getHexByNetwork, getDecimalByNetwork, getValidNetworksList, validateAddressesByNetwork, generateAddress};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Tue Feb 23 2021 20:16:32 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
